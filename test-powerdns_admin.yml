---
- name: Test the functionality of the powerdns_admin collection
  hosts: localhost
  gather_facts: false

  vars:
    powerdns_admin_url: "https://ns1.apps.k8s.kemo.labs"
    powerdns_admin_api_key: Nmp4ZmdhSGszUUpiQ3JM # used for /server endpoints
    powerdns_admin_username: notansible # used for /pdnsadmin endpoints
    powerdns_admin_password: s3cur3P455

    accounts:
      - name: someaccount
        description: Some Account generated by the powerdns_admin collection
        contact: Def Ken
        email: not@kenmoini.com

  tasks:

    - name: List all accounts
      kenmoini.powerdns_admin.account_info:
        pdns_admin_url: "{{ powerdns_admin_url }}"
        pdns_admin_username: "{{ powerdns_admin_username }}"
        pdns_admin_password: "{{ powerdns_admin_password }}"
        skip_tls_verify: true
      register: accounts_info

    - name: Debug the account info
      debug:
        var: accounts_info

    - name: Find all accounts with a specific email
      kenmoini.powerdns_admin.account_info:
        pdns_admin_url: "{{ powerdns_admin_url }}"
        pdns_admin_username: "{{ powerdns_admin_username }}"
        pdns_admin_password: "{{ powerdns_admin_password }}"
        skip_tls_verify: true
        mail: ken@kenmoini.com
      register: email_accounts_info

    - name: Debug the email searched account info
      debug:
        var: email_accounts_info

    - name: Create an account
      kenmoini.powerdns_admin.account:
        pdns_admin_url: "{{ powerdns_admin_url }}"
        #pdns_admin_api_key: "{{ powerdns_admin_api_key }}"
        pdns_admin_username: "{{ powerdns_admin_username }}"
        pdns_admin_password: "{{ powerdns_admin_password }}"
        skip_tls_verify: true
        #state: absent
        name: "{{ item.name }}"
        description: "{{ item.description | default(omit) }}"
        contact: "{{ item.contact | default(omit) }}"
        email: "{{ item.email | default(omit) }}"
      loop: "{{ accounts }}"
      register: account_creation

    - name: Debug the account creation
      debug:
        var: account_creation